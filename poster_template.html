<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Rough.js Running Poster Template</title>
  <script src="https://cdn.jsdelivr.net/npm/roughjs/bundled/rough.min.js"></script>
  <style>
    body { font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif; background:#f6f6f6; padding:20px; }
    .poster-wrap { max-width:1100px; margin:0 auto; background: #fff; border-radius:12px; box-shadow:0 12px 40px rgba(0,0,0,0.08); padding:18px; }
    .controls { display:flex; gap:10px; margin-bottom:12px; }
    button { background:#2b8aef; color:#fff; border:0; padding:8px 12px; border-radius:8px; cursor:pointer }
    #poster { width:100%; height:700px; display:block; }
    .note { font-size:13px; color:#666; margin-top:8px }
  </style>
</head>
<body>
  <div class="poster-wrap">
    <div class="controls">
      <button id="renderBtn">Render Sample Poster</button>
      <button id="exportBtn">Export PNG</button>
      <button id="generateAIPosterBtn" style="background: #10a37f;">Generate AI Poster</button>
    </div>
    <div id="svgHolder"></div>
    <div id="aiPosterContainer" style="display: none; margin-top: 20px; text-align: center;">
      <h3>AI-Generated Poster</h3>
      <div id="aiPosterLoading" style="display: none; margin: 20px 0;">
        <p>Generating your custom poster with AI... This may take a moment.</p>
        <div class="loader" style="border: 5px solid #f3f3f3; border-top: 5px solid #10a37f; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 10px auto;"></div>
      </div>
      <img id="aiPosterImage" style="max-width: 100%; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);" />
    </div>
    <div class="note">This template uses Rough.js to draw a doodle-style running summary. Call <code>renderPoster(data, 'svgHolder')</code> with your data. The server replaces <code>__SAMPLE_DATA__</code> with live JSON when available.</div>
    <style>
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    </style>
  </div>

  <script>
    // Reusable function: renderPoster(data, containerId)
    // Expected `data` shape (server injects JSON into __SAMPLE_DATA__ placeholder)
    const sampleData = __SAMPLE_DATA__;

    // Helper: draw text with rough rectangle behind it for heading badges
    function drawBadge(rc, svg, x, y, text, options = {}) {
      const svgNS = 'http://www.w3.org/2000/svg';
      const g = document.createElementNS(svgNS, 'g');
      const rect = rc.rectangle(x - 8, y - 28, 220, 42, Object.assign({ fill: '#fff9e6', fillStyle: 'hachure', roughness: 1.8, stroke: '#e67e22' }, options));
      g.appendChild(rect);
      const t = document.createElementNS(svgNS, 'text');
      t.setAttribute('x', x + 4);
      t.setAttribute('y', y);
      t.setAttribute('font-size', 18);
      t.setAttribute('fill', '#222');
      t.setAttribute('font-weight', 700);
      t.textContent = text;
      g.appendChild(t);
      svg.appendChild(g);
    }

    function prettyMonth(key) {
      try { return new Date(key + '-01').toLocaleString(undefined, { month: 'short' }); } catch(e) { return key; }
    }

    function clearContainer(container) { while (container.firstChild) container.removeChild(container.firstChild); }

    function renderPoster(data, containerId) {
      const container = document.getElementById(containerId);
      if (!container) return console.error('Container not found');
      clearContainer(container);

      const svgNS = 'http://www.w3.org/2000/svg';
      const width = 1000, height = 700, padding = 40;
      const svg = document.createElementNS(svgNS, 'svg');
      svg.setAttribute('width', width);
      svg.setAttribute('height', height);
      svg.setAttribute('viewBox', `0 0 ${width} ${height}`);
      svg.style.display = 'block';
      svg.style.margin = '0 auto';

      // Background base
      const bg = document.createElementNS(svgNS, 'rect');
      bg.setAttribute('x', 0); bg.setAttribute('y', 0); bg.setAttribute('width', width); bg.setAttribute('height', height);
      bg.setAttribute('fill', '#fff8f0');
      svg.appendChild(bg);

      container.appendChild(svg);

      const rc = rough.svg(svg);

      // Hand-drawn outlined frame
      const frame = rc.rectangle(padding/2, padding/2, width - padding, height - padding, { stroke: '#333', strokeWidth: 2.5, roughness: 1.5, bowing: 3 });
      svg.appendChild(frame);

      // Large decorative title banner
      const banner = rc.rectangle(padding + 20, padding + 6, width - (padding + 40), 64, { fill: '#ffd', fillStyle: 'hachure', roughness: 2, stroke: '#d35400' });
      svg.appendChild(banner);
      const title = document.createElementNS(svgNS, 'text');
      title.setAttribute('x', padding + 40);
      title.setAttribute('y', padding + 46);
      title.setAttribute('font-size', 36);
      title.setAttribute('fill', '#1b1b1b');
      title.setAttribute('font-weight', 800);
      title.textContent = `You crushed it! â€¢ ${data.athlete || 'Athlete'} â€¢ 2025 Fitness Wrapped`;
      svg.appendChild(title);

      // small icons & confetti
      for (let i = 0; i < 12; i++) {
        const cx = padding + 30 + Math.random() * (width - padding*2 - 60);
        const cy = 40 + Math.random() * 18;
        const c = rc.circle(cx, cy, 6 + Math.random()*6, { fill: ['#ff6b6b','#ffd36b','#7ee0a8','#7ec8ff'][i%4], roughness:1.8 });
        svg.appendChild(c);
      }

      // Left column: Achievements and totals (styled blocks)
      const leftX = padding + 26, leftY = padding + 100, leftW = 360, leftH = 480;
      // Achievements header
      drawBadge(rc, svg, leftX, leftY - 16, 'Achievements Unlocked!');

      // Totals card
      const card1 = rc.rectangle(leftX - 6, leftY + 6, leftW, 130, { fill: '#e8fbf3', fillStyle: 'hachure', roughness: 1.6, stroke: '#2ecc71' });
      svg.appendChild(card1);
      const t1 = document.createElementNS(svgNS, 'text');
      t1.setAttribute('x', leftX + 8); t1.setAttribute('y', leftY + 40); t1.setAttribute('font-size', 20); t1.setAttribute('fill','#0b5'); t1.textContent = 'Total Stats!'; svg.appendChild(t1);

      const stats = ['Run','Ride','Swim'];
      const icons = ['ðŸƒ','ðŸš´','ðŸŠ'];
      const runsVal = data.monthly ? Object.values(data.monthly).reduce((a,b)=>a+b,0).toFixed(1) : (data.total_distance_km || 0);
      const runStr = `${stats[0]}: ${Math.round(data.total_distance_km || 0)} km`;
      // show three sample lines using available fields if present
      const vRun = document.createElementNS(svgNS,'text'); vRun.setAttribute('x', leftX + 12); vRun.setAttribute('y', leftY + 72); vRun.setAttribute('font-size',18); vRun.textContent = `${icons[0]}  ${runStr}`; svg.appendChild(vRun);
      const vRide = document.createElementNS(svgNS,'text'); vRide.setAttribute('x', leftX + 12); vRide.setAttribute('y', leftY + 96); vRide.setAttribute('font-size',18); vRide.textContent = `${icons[1]}  Ride: - km`; svg.appendChild(vRide);
      const vSwim = document.createElementNS(svgNS,'text'); vSwim.setAttribute('x', leftX + 12); vSwim.setAttribute('y', leftY + 120); vSwim.setAttribute('font-size',18); vSwim.textContent = `${icons[2]}  Swim: - sessions`; svg.appendChild(vSwim);

      // Big total distance ribbon
      const ribbon = rc.rectangle(leftX - 10, leftY + 150, leftW + 12, 68, { fill: '#fff4e6', fillStyle:'hachure', roughness:1.6, stroke:'#e67e22' }); svg.appendChild(ribbon);
      const totalText = document.createElementNS(svgNS,'text'); totalText.setAttribute('x', leftX + 16); totalText.setAttribute('y', leftY + 190); totalText.setAttribute('font-size',34); totalText.setAttribute('fill','#d35400'); totalText.textContent = `your total distance: ${Math.round(data.total_distance_km || 0).toLocaleString()} km`; svg.appendChild(totalText);

      // Total activities box
      const activitiesBox = rc.rectangle(leftX - 6, leftY + 230, leftW, 170, { fill: '#f0f8ff', fillStyle:'hachure', roughness:1.4, stroke:'#3498db' }); svg.appendChild(activitiesBox);
      const actTitle = document.createElementNS(svgNS,'text'); actTitle.setAttribute('x', leftX + 12); actTitle.setAttribute('y', leftY + 258); actTitle.setAttribute('font-size',20); actTitle.textContent = 'Total Activities'; svg.appendChild(actTitle);
      // activities list
      const totals = data.total_runs || data.total_activities || 0;
      const a1 = document.createElementNS(svgNS,'text'); a1.setAttribute('x', leftX + 18); a1.setAttribute('y', leftY + 290); a1.setAttribute('font-size',18); a1.textContent = `Run Ã— ${data.total_runs || totals}`; svg.appendChild(a1);
      const a2 = document.createElementNS(svgNS,'text'); a2.setAttribute('x', leftX + 18); a2.setAttribute('y', leftY + 316); a2.setAttribute('font-size',18); a2.textContent = `Other Ã— ${data.total_activities - (data.total_runs||0) || 0}`; svg.appendChild(a2);

      // early bird / fun stat
      const funBox = rc.rectangle(leftX + 200, leftY + 232, 130, 130, { fill:'#fff9f3', fillStyle:'hachure', roughness:1.2, stroke:'#f39c12' }); svg.appendChild(funBox);
      const fb = document.createElementNS(svgNS,'text'); fb.setAttribute('x', leftX + 214); fb.setAttribute('y', leftY + 264); fb.setAttribute('font-size',16); fb.textContent = `Early Bird`; svg.appendChild(fb);
      const fb2 = document.createElementNS(svgNS,'text'); fb2.setAttribute('x', leftX + 214); fb2.setAttribute('y', leftY + 288); fb2.setAttribute('font-size',14); fb2.textContent = `${data.early_bird_count || 0} early runs`; svg.appendChild(fb2);

      // Small doodle icons via rough shapes
      const sun = rc.circle(leftX + leftW - 60, leftY + 50, 36, { fill: '#FFDA79', stroke: '#f39c12', roughness: 1.4 }); svg.appendChild(sun);
      const moon = rc.polygon([[leftX + leftW - 110, leftY + 90],[leftX + leftW - 82, leftY + 110],[leftX + leftW - 130, leftY + 120]], { fill: '#dfe7ff', stroke: '#5d6dff', roughness: 1.3 }); svg.appendChild(moon);

      // Right column: main avatar & monthly chart
      const chartX = leftX + leftW + 40, chartY = leftY + 10, chartW = width - chartX - padding - 30, chartH = 420;

      // avatar placeholder (doodle person)
      const avatarX = chartX + chartW/2 - 60, avatarY = chartY + 10;
      const avatar = rc.rectangle(avatarX, avatarY, 140, 280, { fill: '#dfefff', fillStyle:'solid', roughness:1.6, stroke:'#2c3e50' }); svg.appendChild(avatar);
      const bib = document.createElementNS(svgNS,'text'); bib.setAttribute('x', avatarX + 22); bib.setAttribute('y', avatarY + 170); bib.setAttribute('font-size',18); bib.textContent = 'U047'; svg.appendChild(bib);
      const months = Object.keys(data.monthly || {});
      const vals = months.map(k => data.monthly[k]);
      const maxVal = Math.max(1, ...vals);
      const barGap = 8;
      const barW = Math.max(8, (chartW - (months.length - 1) * barGap) / months.length);

      // Chart title
      const chartTitle = document.createElementNS(svgNS, 'text');
      chartTitle.setAttribute('x', chartX);
      chartTitle.setAttribute('y', chartY + 18);
      chartTitle.setAttribute('font-size', 18);
      chartTitle.setAttribute('fill', '#222');
      chartTitle.textContent = 'Monthly Mileage (km)';
      svg.appendChild(chartTitle);

      // Draw baseline
      const baseY = chartY + chartH;
      const baseLine = rc.line(chartX, baseY, chartX + chartW, baseY, { stroke: '#333', roughness: 1.2 }); svg.appendChild(baseLine);

      months.forEach((m, i) => {
        const v = data.monthly[m] || 0;
        const barH = (v / maxVal) * (chartH - 40);
        const x = chartX + i * (barW + barGap);
        const y = baseY - barH - 6;
        const bar = rc.rectangle(x, y, barW, barH, { fill: '#7ee0a8', stroke: '#2e8b57', roughness: 1.2 }); svg.appendChild(bar);

        const label = document.createElementNS(svgNS, 'text');
        label.setAttribute('x', x + barW/2);
        label.setAttribute('y', baseY + 16);
        label.setAttribute('font-size', 12);
        label.setAttribute('text-anchor', 'middle');
        label.setAttribute('fill', '#333');
        label.textContent = prettyMonth(m);
        svg.appendChild(label);
      });

      // Add a simple trend polyline (smooth-ish) using rough path
      const trendPoints = months.map((m, i) => {
        const v = data.monthly[m] || 0;
        const x = chartX + i * (barW + barGap) + barW/2;
        const y = baseY - ((v / maxVal) * (chartH - 40)) - 6;
        return [x, y];
      });
      if (trendPoints.length > 1) {
        let path = '';
        trendPoints.forEach((p, idx) => { path += (idx === 0 ? 'M' : 'L') + p[0] + ' ' + p[1] + ' '; });
        const trend = rc.path(path, { stroke: '#ff6b6b', strokeWidth: 2.5, roughness: 1.5 }); svg.appendChild(trend);
      }

      // Bottom left: trends bullets
      const trendX = leftX + 10, trendY = leftY + leftH + 18;
      const trendBox = rc.rectangle(trendX - 8, trendY - 18, width - padding - trendX - 10, 120, { fill: '#fff', fillStyle: 'cross-hatch', roughness: 1.3, stroke: '#333' }); svg.appendChild(trendBox);

      const trendTitle = document.createElementNS(svgNS, 'text');
      trendTitle.setAttribute('x', trendX);
      trendTitle.setAttribute('y', trendY);
      trendTitle.setAttribute('font-size', 16);
      trendTitle.setAttribute('fill', '#222');
      trendTitle.textContent = 'Trends & Notes';
      svg.appendChild(trendTitle);

      (data.trends || []).slice(0,4).forEach((t, i) => {
        const y = trendY + 24 + i * 20;
        const dot = rc.circle(trendX - 2, y - 6, 6, { fill: '#333', roughness: 1.4 }); svg.appendChild(dot);
        const ttext = document.createElementNS(svgNS, 'text');
        ttext.setAttribute('x', trendX + 14);
        ttext.setAttribute('y', y);
        ttext.setAttribute('font-size', 13);
        ttext.setAttribute('fill', '#333');
        ttext.textContent = t;
        svg.appendChild(ttext);
      });

      // Tiny footer doodle signature
      const sig = rc.rectangle(width - 180, height - 60, 140, 36, { fill: '#fff', fillStyle: 'hachure', roughness: 1.2, stroke: '#222' }); svg.appendChild(sig);
      const sigText = document.createElementNS(svgNS, 'text');
      sigText.setAttribute('x', width - 150); sigText.setAttribute('y', height - 36);
      sigText.setAttribute('font-size', 12); sigText.setAttribute('fill', '#222'); sigText.textContent = 'Doodle Poster â€¢ Rough.js'; svg.appendChild(sigText);

      return svg;
    }

    document.getElementById('renderBtn').addEventListener('click', () => renderPoster(sampleData, 'svgHolder'));

    document.getElementById('exportBtn').addEventListener('click', () => {
      const holder = document.getElementById('svgHolder');
      const svg = holder.querySelector('svg');
      if (!svg) return alert('Render a poster first');
      const serializer = new XMLSerializer();
      const svgStr = serializer.serializeToString(svg);
      const img = new Image();
      const svgBlob = new Blob([svgStr], { type: 'image/svg+xml;charset=utf-8' });
      const url = URL.createObjectURL(svgBlob);
      img.onload = function() {
        const canvas = document.createElement('canvas');
        canvas.width = svg.getAttribute('width');
        canvas.height = svg.getAttribute('height');
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = '#fff'; ctx.fillRect(0,0,canvas.width, canvas.height);
        ctx.drawImage(img, 0, 0);
        URL.revokeObjectURL(url);
        const png = canvas.toDataURL('image/png');
        const a = document.createElement('a');
        a.href = png; a.download = 'running-poster.png';
        a.click();
      };
      img.src = url;
    });

    // AI Poster Generation
    document.getElementById('generateAIPosterBtn').addEventListener('click', async () => {
      const btn = document.getElementById('generateAIPosterBtn');
      const loadingDiv = document.getElementById('aiPosterLoading');
      const posterContainer = document.getElementById('aiPosterContainer');
      const posterImage = document.getElementById('aiPosterImage');
      
      try {
        // Show loading state
        btn.disabled = true;
        loadingDiv.style.display = 'block';
        posterContainer.style.display = 'block';
        posterImage.style.display = 'none';
        
        // Make API call to generate poster
        const response = await fetch('/generate-grok-poster', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          credentials: 'same-origin'
        });
        
        if (!response.ok) {
          const error = await response.json().catch(() => ({}));
          throw new Error(error.error || 'Failed to generate poster');
        }
        
        const data = await response.json();
        if (data.success && data.image_url) {
          image.src = data.image_url;
          image.alt = 'AI Generated Running Poster';
          image.style.display = 'block';
          // Scroll to the generated image
          container.scrollIntoView({ behavior: 'smooth' });
        } else {
          throw new Error(data.error || 'No image URL returned');
        }
      } catch (error) {
        console.error('Error generating AI poster:', error);
        alert('Failed to generate AI poster. Please try again.');
      } finally {
        loading.style.display = 'none';
      }
    });
    
    // Expose globally for programmatic use
    window.renderPoster = renderPoster;
  </script>
</body>
</html>
