<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Rough.js Running Poster Template</title>
  <script src="https://cdn.jsdelivr.net/npm/roughjs/bundled/rough.min.js"></script>
  <style>
    body { font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif; background:#f6f6f6; padding:20px; }
    .poster-wrap { max-width:1100px; margin:0 auto; background: #fff; border-radius:12px; box-shadow:0 12px 40px rgba(0,0,0,0.08); padding:18px; }
    .controls { display:flex; gap:10px; margin-bottom:12px; }
    button { background:#2b8aef; color:#fff; border:0; padding:8px 12px; border-radius:8px; cursor:pointer }
    #poster { width:100%; height:700px; display:block; }
    .note { font-size:13px; color:#666; margin-top:8px }
  </style>
</head>
<body>
  <div class="poster-wrap">
    <div class="controls">
      <button id="renderBtn">Render Sample Poster</button>
      <button id="exportBtn">Export PNG</button>
    </div>
    <div id="svgHolder"></div>
    <div class="note">This template uses Rough.js to draw a doodle-style running summary. Call <code>renderPoster(data, 'svgHolder')</code> with your data.</div>
  </div>

  <script>
    // Reusable function: renderPoster(data, containerId)
    // Expected `data` shape (example below). Server will inject real data when available.
    // Placeholder token `__SAMPLE_DATA__` will be replaced by the server with a JSON object.
    const sampleData = __SAMPLE_DATA__;

    function prettyMonth(key) {
      try { return new Date(key + '-01').toLocaleString(undefined, { month: 'short' }); } catch(e) { return key; }
    }

    function clearContainer(container) { while (container.firstChild) container.removeChild(container.firstChild); }

    function renderPoster(data, containerId) {
      const container = document.getElementById(containerId);
      if (!container) return console.error('Container not found');
      clearContainer(container);

      const svgNS = 'http://www.w3.org/2000/svg';
      const width = 1000, height = 700, padding = 40;
      const svg = document.createElementNS(svgNS, 'svg');
      svg.setAttribute('width', width);
      svg.setAttribute('height', height);
      svg.setAttribute('viewBox', `0 0 ${width} ${height}`);
      svg.style.display = 'block';
      svg.style.margin = '0 auto';

      // Background base
      const bg = document.createElementNS(svgNS, 'rect');
      bg.setAttribute('x', 0); bg.setAttribute('y', 0); bg.setAttribute('width', width); bg.setAttribute('height', height);
      bg.setAttribute('fill', '#fff8f0');
      svg.appendChild(bg);

      container.appendChild(svg);

      const rc = rough.svg(svg);

      // Hand-drawn outlined frame
      const frame = rc.rectangle(padding/2, padding/2, width - padding, height - padding, { stroke: '#333', strokeWidth: 2.5, roughness: 1.5, bowing: 3 });
      svg.appendChild(frame);

      // Title
      const titleGroup = document.createElementNS(svgNS, 'g');
      const titleText = document.createElementNS(svgNS, 'text');
      titleText.setAttribute('x', padding + 10);
      titleText.setAttribute('y', padding + 38);
      titleText.setAttribute('font-size', 36);
      titleText.setAttribute('font-weight', 700);
      titleText.setAttribute('fill', '#222');
      titleText.textContent = `${data.athlete || 'Athlete'} â€” 2025 Running Summary`;
      titleGroup.appendChild(titleText);
      svg.appendChild(titleGroup);

      // Left stats box
      const leftX = padding + 10, leftY = padding + 70, leftW = 340, leftH = 260;
      const leftBox = rc.rectangle(leftX, leftY, leftW, leftH, { fill: '#fff', fillStyle: 'hachure', roughness: 1.2, stroke: '#333' });
      svg.appendChild(leftBox);

      // Draw big stat numbers
      const statX = leftX + 18, statY = leftY + 36;
      const bigText = document.createElementNS(svgNS, 'text');
      bigText.setAttribute('x', statX);
      bigText.setAttribute('y', statY);
      bigText.setAttribute('font-size', 28);
      bigText.setAttribute('fill', '#111');
      bigText.textContent = `${data.total_runs} runs Â· ${data.total_distance_km} km`;
      svg.appendChild(bigText);

      const streakText = document.createElementNS(svgNS, 'text');
      streakText.setAttribute('x', statX);
      streakText.setAttribute('y', statY + 42);
      streakText.setAttribute('font-size', 18);
      streakText.setAttribute('fill', '#333');
      streakText.textContent = `Streak: ${data.current_streak} (Max ${data.max_streak})`;
      svg.appendChild(streakText);

      const earlyText = document.createElementNS(svgNS, 'text');
      earlyText.setAttribute('x', statX);
      earlyText.setAttribute('y', statY + 74);
      earlyText.setAttribute('font-size', 16);
      earlyText.setAttribute('fill', '#333');
      earlyText.textContent = `Early bird: ${data.early_bird_count} â°  |  Night owl: ${data.night_owl_count} ðŸŒ™`;
      svg.appendChild(earlyText);

      // Small doodle icons via rough shapes
      const sun = rc.circle(leftX + leftW - 60, leftY + 50, 36, { fill: '#FFDA79', stroke: '#f39c12', roughness: 1.4 }); svg.appendChild(sun);
      const moon = rc.polygon([[leftX + leftW - 110, leftY + 90],[leftX + leftW - 82, leftY + 110],[leftX + leftW - 130, leftY + 120]], { fill: '#dfe7ff', stroke: '#5d6dff', roughness: 1.3 }); svg.appendChild(moon);

      // Right side: Monthly bar chart
      const chartX = leftX + leftW + 30, chartY = leftY, chartW = width - chartX - padding - 10, chartH = 300;
      const months = Object.keys(data.monthly || {});
      const vals = months.map(k => data.monthly[k]);
      const maxVal = Math.max(1, ...vals);
      const barGap = 8;
      const barW = Math.max(8, (chartW - (months.length - 1) * barGap) / months.length);

      // Chart title
      const chartTitle = document.createElementNS(svgNS, 'text');
      chartTitle.setAttribute('x', chartX);
      chartTitle.setAttribute('y', chartY + 18);
      chartTitle.setAttribute('font-size', 18);
      chartTitle.setAttribute('fill', '#222');
      chartTitle.textContent = 'Monthly Mileage (km)';
      svg.appendChild(chartTitle);

      // Draw baseline
      const baseY = chartY + chartH;
      const baseLine = rc.line(chartX, baseY, chartX + chartW, baseY, { stroke: '#333', roughness: 1.2 }); svg.appendChild(baseLine);

      months.forEach((m, i) => {
        const v = data.monthly[m] || 0;
        const barH = (v / maxVal) * (chartH - 40);
        const x = chartX + i * (barW + barGap);
        const y = baseY - barH - 6;
        const bar = rc.rectangle(x, y, barW, barH, { fill: '#7ee0a8', stroke: '#2e8b57', roughness: 1.2 }); svg.appendChild(bar);

        const label = document.createElementNS(svgNS, 'text');
        label.setAttribute('x', x + barW/2);
        label.setAttribute('y', baseY + 16);
        label.setAttribute('font-size', 12);
        label.setAttribute('text-anchor', 'middle');
        label.setAttribute('fill', '#333');
        label.textContent = prettyMonth(m);
        svg.appendChild(label);
      });

      // Add a simple trend polyline (smooth-ish) using rough path
      const trendPoints = months.map((m, i) => {
        const v = data.monthly[m] || 0;
        const x = chartX + i * (barW + barGap) + barW/2;
        const y = baseY - ((v / maxVal) * (chartH - 40)) - 6;
        return [x, y];
      });
      if (trendPoints.length > 1) {
        let path = '';
        trendPoints.forEach((p, idx) => { path += (idx === 0 ? 'M' : 'L') + p[0] + ' ' + p[1] + ' '; });
        const trend = rc.path(path, { stroke: '#ff6b6b', strokeWidth: 2.5, roughness: 1.5 }); svg.appendChild(trend);
      }

      // Bottom left: trends bullets
      const trendX = leftX + 10, trendY = leftY + leftH + 18;
      const trendBox = rc.rectangle(trendX - 8, trendY - 18, width - padding - trendX - 10, 120, { fill: '#fff', fillStyle: 'cross-hatch', roughness: 1.3, stroke: '#333' }); svg.appendChild(trendBox);

      const trendTitle = document.createElementNS(svgNS, 'text');
      trendTitle.setAttribute('x', trendX);
      trendTitle.setAttribute('y', trendY);
      trendTitle.setAttribute('font-size', 16);
      trendTitle.setAttribute('fill', '#222');
      trendTitle.textContent = 'Trends & Notes';
      svg.appendChild(trendTitle);

      (data.trends || []).slice(0,4).forEach((t, i) => {
        const y = trendY + 24 + i * 20;
        const dot = rc.circle(trendX - 2, y - 6, 6, { fill: '#333', roughness: 1.4 }); svg.appendChild(dot);
        const ttext = document.createElementNS(svgNS, 'text');
        ttext.setAttribute('x', trendX + 14);
        ttext.setAttribute('y', y);
        ttext.setAttribute('font-size', 13);
        ttext.setAttribute('fill', '#333');
        ttext.textContent = t;
        svg.appendChild(ttext);
      });

      // Tiny footer doodle signature
      const sig = rc.rectangle(width - 180, height - 60, 140, 36, { fill: '#fff', fillStyle: 'hachure', roughness: 1.2, stroke: '#222' }); svg.appendChild(sig);
      const sigText = document.createElementNS(svgNS, 'text');
      sigText.setAttribute('x', width - 150); sigText.setAttribute('y', height - 36);
      sigText.setAttribute('font-size', 12); sigText.setAttribute('fill', '#222'); sigText.textContent = 'Doodle Poster â€¢ Rough.js'; svg.appendChild(sigText);

      return svg;
    }

    document.getElementById('renderBtn').addEventListener('click', () => renderPoster(sampleData, 'svgHolder'));

    document.getElementById('exportBtn').addEventListener('click', () => {
      const holder = document.getElementById('svgHolder');
      const svg = holder.querySelector('svg');
      if (!svg) return alert('Render a poster first');
      const serializer = new XMLSerializer();
      const svgStr = serializer.serializeToString(svg);
      const img = new Image();
      const svgBlob = new Blob([svgStr], { type: 'image/svg+xml;charset=utf-8' });
      const url = URL.createObjectURL(svgBlob);
      img.onload = function() {
        const canvas = document.createElement('canvas');
        canvas.width = svg.getAttribute('width');
        canvas.height = svg.getAttribute('height');
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = '#fff'; ctx.fillRect(0,0,canvas.width, canvas.height);
        ctx.drawImage(img, 0, 0);
        URL.revokeObjectURL(url);
        const png = canvas.toDataURL('image/png');
        const a = document.createElement('a');
        a.href = png; a.download = 'running-poster.png';
        a.click();
      };
      img.src = url;
    });

    // Expose globally for programmatic use
    window.renderPoster = renderPoster;
  </script>
</body>
</html>
